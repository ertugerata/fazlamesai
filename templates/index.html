<!DOCTYPE html>
<html lang="tr" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazla Mesai Takip (Flask)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .hidden { display: none; }
        /* Basit animasyonlar */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <!-- Pazar Günü Gerekçe Modalı -->
    <div id="sunday-reason-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold dark:text-white mb-4">Pazar Günü Çalışma Nedeni</h3>
            <textarea id="sunday-reason-input" class="w-full p-2 border rounded bg-gray-100 dark:bg-gray-700" rows="3" placeholder="Lütfen bir neden belirtin..."></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button id="cancel-modal-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">İptal</button>
                <button id="save-reason-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Çalışan Maaş Ayarları Modalı -->
    <div id="salary-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold dark:text-white">Maaş Ayarları</h3>
                <button id="close-salary-modal-btn" class="text-gray-400 hover:text-red-500">&times;</button>
            </div>
            <form id="salary-settings-form" class="space-y-4">
                <input type="hidden" id="modal-employee-id">
                <div>
                    <label for="payment-type" class="block mb-2 font-semibold">Ödeme Tipi</label>
                    <select id="payment-type" class="w-full p-2 border rounded bg-white dark:bg-slate-700">
                        <option value="asgari_ucret_fazla_mesai">Asgari Ücret + Fazla Mesai</option>
                        <option value="sabit_maas">Yalnızca Sabit Maaş</option>
                        <option value="sabit_maas_nobet">Sabit Maaş + Nöbet</option>
                        <option value="yalnizca_fazla_mesai">Yalnızca Fazla Mesai</option>
                    </select>
                </div>
                <div id="fixed-salary-container" class="hidden">
                    <label for="fixed-salary" class="block mb-2 font-semibold">Sabit Maaş Tutarı (₺)</label>
                    <input type="number" id="fixed-salary" class="w-full p-2 border rounded bg-white dark:bg-slate-700" step="0.01">
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" id="cancel-salary-modal-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Kaydet</button>
                </div>
            </form>
        </div>
    </div>


    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
            <!-- Üst Başlık ve Kontroller -->
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Fazla Mesai ve Maaş Takip</h1>
                <div class="flex items-center gap-4">
                    <input type="month" id="selected-month" class="px-4 py-2 border rounded-lg dark:bg-slate-700">
                    <button id="export-report-btn" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg">
                        <i data-lucide="download"></i> Dışa Aktar
                    </button>
                    <button id="dark-mode-toggle" class="p-2 rounded-lg bg-blue-100 dark:bg-slate-700">
                         <i data-lucide="sun" class="hidden dark:inline"></i><i data-lucide="moon" class="inline dark:hidden"></i>
                    </button>
                </div>
            </div>

            <!-- Sekmeler -->
            <div id="tabs" class="flex gap-4 border-b border-gray-200 dark:border-slate-700">
                <button data-tab="employees" class="tab-btn">Çalışanlar</button>
                <button data-tab="worklog" class="tab-btn">Çalışma Saatleri</button>
                <button data-tab="holidays" class="tab-btn">Tatil Günleri</button>
                <button data-tab="report" class="tab-btn">Rapor</button>
                <button data-tab="settings" class="tab-btn">Ayarlar</button>
            </div>

            <!-- Sekme İçerikleri -->
            <div class="pt-6">
                <!-- Çalışanlar Sekmesi -->
                <div id="employees-tab" class="tab-content">
                     <form id="add-employee-form" class="mb-6 flex gap-2">
                        <input type="text" id="new-employee-name" placeholder="Ad Soyad" required class="flex-grow p-2 border rounded dark:bg-slate-700">
                        <input type="text" id="new-employee-id" placeholder="Çalışan No" class="p-2 border rounded dark:bg-slate-700">
                        <button type="submit" class="p-2 bg-blue-600 text-white rounded-lg">Ekle</button>
                    </form>
                    <input type="file" id="employee-file-upload" class="hidden" accept=".xlsx,.xls">
                    <label for="employee-file-upload" class="cursor-pointer mb-6 p-2 bg-green-500 text-white rounded-lg inline-block">Excel'den Yükle</label>
                    <div id="employee-list-container"></div>
                </div>

                <!-- Çalışma Saatleri Sekmesi -->
                <div id="worklog-tab" class="tab-content hidden">
                     <div class="mb-4 flex gap-2">
                        <input type="file" id="worklog-file-upload" class="hidden" accept=".xlsx,.xls">
                        <label for="worklog-file-upload" class="cursor-pointer p-2 bg-orange-500 text-white rounded-lg">Saatleri Yükle</label>
                        <button id="download-template-btn" class="p-2 bg-blue-600 text-white rounded-lg">Şablon İndir</button>
                    </div>
                    <div id="worklog-grid-container"></div>
                </div>

                <!-- Tatil Günleri Sekmesi -->
                <div id="holidays-tab" class="tab-content hidden">
                    <form id="add-holiday-form" class="mb-6 flex gap-2">
                        <input type="date" id="new-holiday-date" required class="p-2 border rounded dark:bg-slate-700">
                        <button type="submit" class="p-2 bg-blue-600 text-white rounded-lg">Tatil Ekle</button>
                    </form>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h3 class="font-bold text-lg mb-2">Eklenen Tatiller</h3>
                            <div id="custom-holidays-list"></div>
                        </div>
                         <div>
                            <h3 class="font-bold text-lg mb-2">2025 Resmi Tatiller</h3>
                            <div id="official-holidays-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Rapor Sekmesi -->
                <div id="report-tab" class="tab-content hidden">
                    <div id="report-container" class="space-y-4"></div>
                </div>

                <!-- Ayarlar Sekmesi -->
                <div id="settings-tab" class="tab-content hidden">
                    <div class="space-y-4 max-w-md">
                        <div>
                            <label for="minimumWage" class="block font-semibold">Asgari Ücret (Aylık)</label>
                            <input type="number" id="minimumWage" class="w-full p-2 border rounded dark:bg-slate-700">
                        </div>
                        <div>
                            <label for="dayRate" class="block font-semibold">Gündüz Fazla Mesai Saat Ücreti (₺)</label>
                            <input type="number" id="dayRate" class="w-full p-2 border rounded dark:bg-slate-700">
                        </div>
                        <div>
                            <label for="eveningRate" class="block font-semibold">Akşam/Hafta Sonu Saat Ücreti (₺)</label>
                            <input type="number" id="eveningRate" class="w-full p-2 border rounded dark:bg-slate-700">
                        </div>
                        <button id="save-settings-btn" class="p-2 bg-blue-600 text-white rounded-lg">Ayarları Kaydet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE ---
    let state = {
        employees: [],
        workLogs: {},
        holidays: [],
        settings: { dayRate: 100, eveningRate: 120, minimumWage: 17002 },
        activeTab: 'employees',
        selectedMonth: new Date().toISOString().slice(0, 7),
        sundayModalData: null,
    };

    const OFFICIAL_HOLIDAYS_2025 = [
        { date: '2025-01-01', description: 'Yılbaşı' }, { date: '2025-03-31', description: 'Ramazan Bayramı' },
        { date: '2025-04-01', description: 'Ramazan Bayramı' }, { date: '2025-04-02', description: 'Ramazan Bayramı' },
        { date: '2025-04-23', description: 'Ulusal Egemenlik' }, { date: '2025-05-01', description: 'Emek ve Dayanışma' },
        { date: '2025-05-19', description: 'Gençlik ve Spor' }, { date: '2025-06-27', description: 'Kurban Bayramı' },
        { date: '2025-06-28', description: 'Kurban Bayramı' }, { date: '2025-06-29', description: 'Kurban Bayramı' },
        { date: '2025-06-30', description: 'Kurban Bayramı' }, { date: '2025-08-30', description: 'Zafer Bayramı' },
        { date: '2025-09-05', description: 'Kurban Bayramı' }, { date: '2025-09-06', description: 'Kurban Bayramı' },
        { date: '2025-09-07', description: 'Kurban Bayramı' }, { date: '2025-09-08', description: 'Kurban Bayramı' },
        { date: '2025-10-29', description: 'Cumhuriyet Bayramı' },
    ];
    const PAYMENT_TYPE_MAP = {
        'asgari_ucret_fazla_mesai': 'Asgari Ücret + Fazla Mesai',
        'sabit_maas': 'Yalnızca Sabit Maaş',
        'sabit_maas_nobet': 'Sabit Maaş + Nöbet',
        'yalnizca_fazla_mesai': 'Yalnızca Fazla Mesai'
    };


    // --- SELECTORS ---
    const qs = (selector) => document.querySelector(selector);
    const monthInput = qs('#selected-month');
    const employeeListContainer = qs('#employee-list-container');
    const worklogGridContainer = qs('#worklog-grid-container');
    const reportContainer = qs('#report-container');
    const customHolidaysList = qs('#custom-holidays-list');
    const officialHolidaysList = qs('#official-holidays-list');
    const dayRateInput = qs('#dayRate');
    const eveningRateInput = qs('#eveningRate');
    const minimumWageInput = qs('#minimumWage');

    // Modals
    const sundayModal = qs('#sunday-reason-modal');
    const salaryModal = qs('#salary-settings-modal');

    // --- API HELPERS ---
    const api = {
        get: (url) => fetch(url).then(res => res.ok ? res.json() : Promise.reject(res)),
        post: (url, data) => fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(res => res.ok ? res.json() : Promise.reject(res)),
        put: (url, data) => fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(res => res.ok ? res.json() : Promise.reject(res)),
        delete: (url) => fetch(url, { method: 'DELETE' }).then(res => res.ok ? res.json() : Promise.reject(res)),
        upload: (url, formData) => fetch(url, { method: 'POST', body: formData }).then(res => res.ok ? res.json() : Promise.reject(res))
    };

    // --- RENDER FUNCTIONS ---
    const render = () => {
        renderTabs();
        switch(state.activeTab) {
            case 'employees': renderEmployees(); break;
            case 'worklog': renderWorklog(); break;
            case 'holidays': renderHolidays(); break;
            case 'report': renderReport(); break;
            case 'settings': renderSettings(); break;
        }
        lucide.createIcons();
    };

    const renderTabs = () => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        qs(`#${state.activeTab}-tab`).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('text-blue-600', btn.dataset.tab === state.activeTab);
            btn.classList.toggle('border-b-2', btn.dataset.tab === state.activeTab);
            btn.classList.toggle('border-blue-600', btn.dataset.tab === state.activeTab);
        });
    };

    const renderEmployees = () => {
        employeeListContainer.innerHTML = `
            <h3 class="font-bold text-xl mb-4">Çalışan Listesi (${state.employees.length})</h3>
            <div class="space-y-2">
                ${state.employees.map(emp => `
                    <div class="flex items-center justify-between bg-white dark:bg-slate-800/50 p-3 rounded-lg">
                        <div>
                            <p class="font-semibold">${emp.name} <span class="text-sm text-gray-500">(${PAYMENT_TYPE_MAP[emp.payment_type]})</span></p>
                            ${emp.emp_id ? `<p class="text-xs text-gray-400">No: ${emp.emp_id}</p>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button class="salary-settings-btn p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded" data-id="${emp.id}"><i data-lucide="settings-2"></i></button>
                            <button class="delete-employee-btn p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded" data-id="${emp.id}"><i data-lucide="trash-2"></i></button>
                        </div>
                    </div>
                `).join('') || '<p>Henüz çalışan eklenmedi.</p>'}
            </div>`;
    };

     const renderWorklog = () => {
        if (state.employees.length === 0) {
            worklogGridContainer.innerHTML = '<p>Önce çalışan ekleyin</p>'; return;
        }
        const [year, month] = state.selectedMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        const dayNames = ['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'];
        const allHolidays = [...state.holidays, ...OFFICIAL_HOLIDAYS_2025.map(h => h.date)];

        worklogGridContainer.innerHTML = state.employees.map(emp => `
            <div class="bg-white dark:bg-slate-800/50 p-4 rounded-lg mb-4">
                <h3 class="font-bold text-lg mb-2">${emp.name} ${emp.emp_id ? `<span class="text-sm font-normal text-gray-500">(${emp.emp_id})</span>` : ''}</h3>
                <div class="grid grid-cols-7 gap-2">
                    ${Array.from({ length: daysInMonth }, (_, i) => {
                        const d = new Date(year, month - 1, i + 1);
                        const dateStr = d.toISOString().slice(0, 10);
                        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                        const isHoliday = allHolidays.includes(dateStr);
                        const log = state.workLogs[emp.id]?.[dateStr] || { day: 0, evening: 0, reason: '' };
                        return `
                        <div class="text-center p-2 rounded ${isHoliday ? 'bg-red-100 dark:bg-red-900/50' : isWeekend ? 'bg-yellow-100 dark:bg-yellow-900/50' : 'bg-blue-50 dark:bg-slate-700/50'}">
                            <div class="text-xs font-bold flex justify-center items-center">${dayNames[d.getDay()]} ${log.reason ? `<div class="relative group ml-1"><i data-lucide="message-square" class="w-3 h-3 text-blue-500"></i><div class="absolute bottom-full mb-1 w-40 bg-gray-800 text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">${log.reason}</div></div>` : ''}</div>
                            <div class="font-semibold">${i + 1}</div>
                            <input type="number" min="0" step="1" placeholder="G" value="${log.day || ''}" data-emp-id="${emp.id}" data-date="${dateStr}" data-type="day" data-day-of-week="${d.getDay()}" class="worklog-input w-full text-sm p-1 mt-1 border rounded">
                            <input type="number" min="0" step="1" placeholder="A" value="${log.evening || ''}" data-emp-id="${emp.id}" data-date="${dateStr}" data-type="evening" data-day-of-week="${d.getDay()}" class="worklog-input w-full text-sm p-1 mt-1 border rounded">
                        </div>`;
                    }).join('')}
                </div>
            </div>`).join('');
    };

    const renderHolidays = () => {
        customHolidaysList.innerHTML = state.holidays.map(date => `
            <div class="flex justify-between items-center bg-white dark:bg-slate-800/50 p-2 rounded">
                <span>${date}</span>
                <button class="delete-holiday-btn" data-date="${date}"><i data-lucide="trash-2"></i></button>
            </div>`).join('') || '<p>Tatil eklenmedi.</p>';
        officialHolidaysList.innerHTML = OFFICIAL_HOLIDAYS_2025.map(h => `
            <div class="bg-white dark:bg-slate-800/50 p-2 rounded">
                <p>${h.date}</p><p class="text-sm text-gray-500">${h.description}</p>
            </div>`).join('');
    };

    const renderReport = async () => {
        reportContainer.innerHTML = '<p>Hesaplanıyor...</p>';
        const reportData = await api.get(`/api/report/${state.selectedMonth}`);
        if (!reportData || reportData.length === 0) {
            reportContainer.innerHTML = '<p>Rapor verisi bulunamadı.</p>'; return;
        }
        reportContainer.innerHTML = reportData.map(calc => `
             <div class="bg-white dark:bg-slate-800/50 p-4 rounded-lg">
                <h3 class="font-bold text-xl mb-2">${calc.name} <span class="text-base font-normal text-gray-500">- ${PAYMENT_TYPE_MAP[calc.paymentType]}</span></h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${(calc.fixedSalary > 0 || calc.minimumWage > 0) ? `
                    <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded">
                        <p class="text-sm">${calc.fixedSalary > 0 ? 'Sabit Maaş' : 'Asgari Ücret'}</p>
                        <p class="font-bold text-lg">${(calc.fixedSalary || calc.minimumWage).toFixed(2)} ₺</p>
                    </div>` : ''}
                    <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded">
                        <p class="text-sm">Fazla Mesai Ödemesi</p>
                        <p class="font-bold text-lg">${calc.overtimePayment.toFixed(2)} ₺ <span class="font-normal text-sm">(${calc.overtimeHours} sa)</span></p>
                    </div>
                </div>
                <div class="mt-4 bg-blue-600 text-white p-3 rounded-lg text-right">
                    <p class="text-sm">TOPLAM HAKEDİŞ</p>
                    <p class="font-bold text-2xl">${calc.totalPayment.toFixed(2)} ₺</p>
                </div>
                 <p class="text-xs text-gray-500 mt-2">Hesaplama Notu: ${calc.calculationDetails}</p>
            </div>
        `).join('');
    };

    const renderSettings = () => {
        dayRateInput.value = state.settings.dayRate;
        eveningRateInput.value = state.settings.eveningRate;
        minimumWageInput.value = state.settings.minimumWage;
    };

    // --- EVENT HANDLERS ---
    const handleMonthChange = async () => {
        state.selectedMonth = monthInput.value;
        state.workLogs = await api.get(`/api/worklogs/${state.selectedMonth}`);
        render();
    };

    const handleAddEmployee = async (e) => {
        e.preventDefault();
        const name = qs('#new-employee-name').value;
        const emp_id = qs('#new-employee-id').value;
        if (name) {
            const newEmp = await api.post('/api/employees', { name, emp_id });
            state.employees.push(newEmp);
            render();
            e.target.reset();
        }
    };

    const handleEmployeeListClick = async (e) => {
        const deleteBtn = e.target.closest('.delete-employee-btn');
        const settingsBtn = e.target.closest('.salary-settings-btn');

        if (deleteBtn && confirm('Bu çalışanı silmek istediğinizden emin misiniz?')) {
            const id = deleteBtn.dataset.id;
            await api.delete(`/api/employees/${id}`);
            state.employees = state.employees.filter(emp => emp.id != id);
            render();
        }
        if (settingsBtn) {
            const emp = state.employees.find(e => e.id == settingsBtn.dataset.id);
            qs('#modal-title').innerText = `${emp.name} - Maaş Ayarları`;
            qs('#modal-employee-id').value = emp.id;
            const paymentTypeSelect = qs('#payment-type');
            paymentTypeSelect.value = emp.payment_type;
            qs('#fixed-salary').value = emp.fixed_salary;
            qs('#fixed-salary-container').classList.toggle('hidden', !paymentTypeSelect.value.startsWith('sabit_maas'));
            salaryModal.classList.remove('hidden');
        }
    };

    const handleWorklogChange = (e) => {
        if (!e.target.classList.contains('worklog-input')) return;
        const { empId, date, type, dayOfWeek } = e.target.dataset;
        const value = parseInt(e.target.value, 10) || 0;
        const existingLog = state.workLogs[empId]?.[date] || {};

        if (dayOfWeek === '0' && value > 0 && !existingLog.reason) {
            state.sundayModalData = { empId, date, type, value };
            sundayModal.classList.remove('hidden');
        } else {
            updateWorklog(empId, date, type, value);
        }

        // Nöbet saati kontrolü
        const d = new Date(date);
        const isWeekendOrHoliday = d.getDay() === 0 || d.getDay() === 6 || state.holidays.includes(date) || OFFICIAL_HOLIDAYS_2025.some(h => h.date === date);
        if (isWeekendOrHoliday) {
            checkWatchHours(empId);
        }
    };

    const checkWatchHours = (empId) => {
        const employeeLogs = state.workLogs[empId] || {};
        let workedDays = 0;
        let watchHours = 0;
        const [year, month] = state.selectedMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();

        for (let i = 1; i <= daysInMonth; i++) {
            const d = new Date(year, month - 1, i);
            const dateStr = d.toISOString().slice(0, 10);
            const log = employeeLogs[dateStr] || { day: 0, evening: 0 };
            const totalHours = (log.day || 0) + (log.evening || 0);

            if (totalHours > 0) {
                workedDays++;
                const isWeekendOrHoliday = d.getDay() === 0 || d.getDay() === 6 || state.holidays.includes(dateStr) || OFFICIAL_HOLIDAYS_2025.some(h => h.date === dateStr);
                if (isWeekendOrHoliday) {
                    watchHours += totalHours;
                }
            }
        }

        if (watchHours > (workedDays / 2)) {
            // setTimeout, o anki event döngüsü bittikten sonra çalışır, bu da input'un değerinin güncellenmesini sağlar.
            setTimeout(() => {
                alert(`Uyarı: Bu ayki nöbet saati (${watchHours} saat), çalışılan gün sayısının (${workedDays} gün) yarısını aştı.`);
            }, 0);
        }
    };

    const updateWorklog = async (empId, date, type, value, reason = null) => {
        const payload = { empId, date, type, value };
        if (reason !== null) payload.reason = reason;
        await api.post('/api/worklogs', payload);
        if (!state.workLogs[empId]) state.workLogs[empId] = {};
        if (!state.workLogs[empId][date]) state.workLogs[empId][date] = { day: 0, evening: 0, reason: '' };
        state.workLogs[empId][date][type] = value;
        if (reason !== null) state.workLogs[empId][date].reason = reason;
    };

    const handleSaveReason = () => {
        const { empId, date, type, value } = state.sundayModalData;
        const reason = qs('#sunday-reason-input').value;
        if (reason) {
            updateWorklog(empId, date, type, value, reason);
            sundayModal.classList.add('hidden');
            render();
        } else { alert('Lütfen bir neden belirtin.'); }
    };

    const handleSaveSalarySettings = async (e) => {
        e.preventDefault();
        const id = qs('#modal-employee-id').value;
        const payment_type = qs('#payment-type').value;
        const fixed_salary = parseFloat(qs('#fixed-salary').value) || 0;

        await api.put(`/api/employees/${id}`, { payment_type, fixed_salary });
        salaryModal.classList.add('hidden');
        // Veriyi yeniden yükleyerek arayüzün güncel olmasını sağla
        initData();
    };

    const handleSaveSettings = async () => {
        const newSettings = {
            dayRate: parseFloat(dayRateInput.value),
            eveningRate: parseFloat(eveningRateInput.value),
            minimumWage: parseFloat(minimumWageInput.value),
        };
        await api.post('/api/settings', newSettings);
        state.settings = newSettings;
        alert('Ayarlar kaydedildi.');
    };

    const handleFileUpload = async (e, type) => {
        const file = e.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        const url = type === 'employee' ? '/api/employees/upload' : '/api/worklogs/upload';
        try {
            alert((await api.upload(url, formData)).message);
            initData();
        } catch (err) { alert('Hata oluştu.'); }
        finally { e.target.value = ''; }
    };

    // --- INITIALIZATION ---
    const initData = async () => {
        [state.employees, state.workLogs, state.holidays, state.settings] = await Promise.all([
            api.get('/api/employees'),
            api.get(`/api/worklogs/${state.selectedMonth}`),
            api.get('/api/holidays'),
            api.get('/api/settings')
        ]);
        render();
    };

    const init = () => {
        monthInput.value = state.selectedMonth;
        initData();
        if (localStorage.getItem('darkMode') === 'true') document.documentElement.classList.add('dark');

        // Event Listeners
        document.addEventListener('click', e => {
            const tabBtn = e.target.closest('.tab-btn');
            if(tabBtn) { state.activeTab = tabBtn.dataset.tab; render(); }
            if(e.target.closest('#dark-mode-toggle')) {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark);
            }
        });
        monthInput.addEventListener('change', handleMonthChange);
        qs('#add-employee-form').addEventListener('submit', handleAddEmployee);
        employeeListContainer.addEventListener('click', handleEmployeeListClick);
        worklogGridContainer.addEventListener('change', handleWorklogChange);
        qs('#save-reason-btn').addEventListener('click', handleSaveReason);
        qs('#cancel-modal-btn').addEventListener('click', () => sundayModal.classList.add('hidden'));

        // Salary Modal
        qs('#salary-settings-form').addEventListener('submit', handleSaveSalarySettings);
        qs('#cancel-salary-modal-btn').addEventListener('click', () => salaryModal.classList.add('hidden'));
        qs('#close-salary-modal-btn').addEventListener('click', () => salaryModal.classList.add('hidden'));
        qs('#payment-type').addEventListener('change', e => {
            qs('#fixed-salary-container').classList.toggle('hidden', !e.target.value.startsWith('sabit_maas'));
        });

        // Other forms
        qs('#add-holiday-form').addEventListener('submit', async e => {
            e.preventDefault();
            const date = qs('#new-holiday-date').value;
            if(date) { await api.post('/api/holidays', { date }); state.holidays.push(date); state.holidays.sort(); render(); e.target.reset(); }
        });
        customHolidaysList.addEventListener('click', async e => {
            const btn = e.target.closest('.delete-holiday-btn');
            if(btn && confirm('Bu tatili sil?')) { await api.delete(`/api/holidays/${btn.dataset.date}`); state.holidays = state.holidays.filter(d => d !== btn.dataset.date); render(); }
        });
        qs('#save-settings-btn').addEventListener('click', handleSaveSettings);

        // File buttons
        qs('#download-template-btn').addEventListener('click', () => window.location.href = `/api/worklogs/template/${state.selectedMonth}`);
        qs('#export-report-btn').addEventListener('click', () => window.location.href = `/api/report/export/${state.selectedMonth}`);
        qs('#employee-file-upload').addEventListener('change', (e) => handleFileUpload(e, 'employee'));
        qs('#worklog-file-upload').addEventListener('change', (e) => handleFileUpload(e, 'worklog'));
    };

    init();
});
</script>
</body>
</html>
